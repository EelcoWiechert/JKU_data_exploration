<html>
<head>
</head>

<body>

<style>
    body {
        margin: 0;
        padding: 0;
    }

    .horizon {
        border-top: solid 1px #000;
        border-bottom: solid 1px #000;
        overflow: hidden;
        position: relative;
    }

    .horizon + .horizon {
        border-top: none;
    }

    .horizon canvas {
        display: block;
        image-rendering: pixelated;
    }

  .horizon .title,
  .horizon .value {
      bottom: 0;
      line-height: 30px;
      margin: 0 6px;
      position: absolute;
      font-family: sans-serif;
      text-shadow: 0 1px 0 rgba(255,255,255,.5);
      white-space: nowrap;
  }

  .horizon .title {
      left: 0;
  }

  .horizon .value {
      right: 0;
  }

</style>

<div>
  <select id="country_select">
    <option value="UK">United Kingdom</option>
    <option value="PL">Poland</option>
    <option value="US">United States</option>
    <option value="RU">Russia</option>
    <option value="DE">Germany</option>
    <!--<option value="BR">Brasil</option>
    <option value="FI">Finland</option>
    <option value="SE">Sweden</option>
    <option value="NL">Netherlands</option>
    <option value="CA">Canada</option>
    <option value="UA">Ukraine</option>
    <option value="ES">Spain</option>
    <option value="FR">France</option>
    <option value="AU">Australia</option>
    <option value="NO">Norway</option>
    <option value="IT">Italy</option>
    <option value="JP">Japan</option>
    <option value="CZ">Czech Republic</option>-->
  </select>

  <select id="genre_select">
    <option value="rnb">RnB</option>
    <option value="rap">Rap</option>
    <option value="electronic">Electronic</option>
    <option value="rock">Rock</option>
    <option value="new age">New Age</option>
    <option value="classical">Classical</option>
    <option value="reggae">Reggae</option>
    <option value="blues">Blues</option>
    <option value="country">Country</option>
    <option value="world">World</option>
    <option value="folk">Folk</option>
    <option value="easy listening">Easy listening</option>
    <option value="jazz">Jazz</option>
    <option value="vocal">Vocal</option>
    <option value="children's">Children's</option>
    <option value="punk">Punk</option>
    <option value="alternative">Alternative</option>
    <option value="heavy metal">Heavy Metal</option>
    <option value="spoken word">Spoken Word</option>
    <option value="pop">Pop</option>
  </select>

  <button type="button" onclick="show_countries();">Show</button>

  <select id="year_select">
    <option value=2005>2005</option>
    <option value=2006>2006</option>
    <option value=2007>2007</option>
    <!--<option value=2008>2008</option>
    <option value=2009>2009</option>
    <option value=2010>2010</option>
    <option value=2011>2011</option>
    <option value=2012>2012</option>
    <option value=2013>2013</option>
    <option value=2014>2014</option>
    <option value=2015>2015</option>
    <option value=2016>2016</option>-->
  </select>

  <button type="button" onclick="show_countries();">Select year</button>

</div>

<div>
  Events

  <select id="event_select">
    <option value=popular>Popular</option>
    <option value=news>News</option>
    <option value=tech>Technology</option>
    <!--<option value=2008>2008</option>
    <option value=2009>2009</option>
    <option value=2010>2010</option>
    <option value=2011>2011</option>
    <option value=2012>2012</option>
    <option value=2013>2013</option>
    <option value=2014>2014</option>
    <option value=2015>2015</option>
    <option value=2016>2016</option>-->
  </select>
  <button type="button" onclick="plot_lines();">Show</button>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>

<script>

var margin = {top: 10, right: 150, bottom: 20, left: 50}
  , width = window.innerWidth - margin.left - margin.right // Use the window's width
  , height = (window.innerWidth/8) - margin.top - margin.bottom; // Use the window's height

var parseTime = d3.timeParse("%Y-%m-%d");

  // set the ranges
  var x = d3.scaleTime().range([0, width]);
  var y = d3.scaleLinear().range([height, 0]);

  x.domain([parseTime("2005-01-01"), parseTime("2005-01-02")]);
  y.domain([0,1]);

  var x_trend = d3.scaleTime().range([0, width]);
  var y_trend = d3.scaleLinear().range([height, 0]);

  x_trend.domain([parseTime("2005-01-03"), parseTime("2005-01-04")]);
  y_trend.domain([0,1]);

  var x_seasonal = d3.scaleTime().range([0, width]);
  var y_seasonal = d3.scaleLinear().range([height, 0]);

  x_seasonal.domain([parseTime("2005-01-03"), parseTime("2005-01-04")]);
  y_seasonal.domain([0,1]);

  var x_residual = d3.scaleTime().range([0, width]);
  var y_residual = d3.scaleLinear().range([height, 0]);

  x_residual.domain([parseTime("2005-01-03"), parseTime("2005-01-04")]);
  y_residual.domain([0,1]);

  function create_svg(){
    return d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");
  };

  var original_chart = create_svg()
  var trend_chart = create_svg()
  var seasonal_chart = create_svg()
  var residual_chart = create_svg()

  function add_x_axis(chartname, name){
    return chartname.append("g")
              .attr("class", "x_axis")
              .attr("transform", "translate(0," + height + ")")
              .call(d3.axisBottom(name));
  }

  function add_y_axis(chartname, name) {
    return chartname.append("g")
      .attr("class", "y_axis")
      .call(d3.axisLeft(name));
  }
  // Add the X Axis
  add_x_axis(original_chart,x)
  add_x_axis(trend_chart,x_trend)
  add_x_axis(seasonal_chart,x_seasonal)
  add_x_axis(residual_chart,x_residual)

  // Add the Y Axis
  add_y_axis(original_chart,y)
  add_y_axis(trend_chart,y_trend)
  add_y_axis(seasonal_chart,y_seasonal)
  add_y_axis(residual_chart,y_residual)

  function add_clip(chartname){
    return chartname.append("defs").append("clipPath")
      .attr("id", "clip")
      .append("rect")
      .attr("width", width)
      .attr("height", height);
  }

  // add clipPath
  add_clip(original_chart)
  add_clip(trend_chart)
  add_clip(seasonal_chart)
  add_clip(residual_chart)


  var data_to_plot = [];
  var color = ["#377eb8","#4daf4a","#984ea3","#e41a1c","#ff7f00","#a65628"];

  // linedraw function
  var line_original = d3.line()
      .x(function(d) {return x(d.date); })
      .y(function(d) {return y(d.original);
      });

  var line_trend = d3.line()
      .defined(function (d) { return d.trend !== null; })
      .x(function(d) { return x_trend(d.date); })
      .y(function(d) {return y_trend(d.trend);
      });

  var line_seasonal = d3.line()
      .x(function(d) { return x_seasonal(d.date); })
      .y(function(d) {return y_seasonal(d.seasonal);
      });

  var line_residual = d3.line()
      .x(function(d) { return x_residual(d.date); })
      .y(function(d) {return y_residual(d.residual);
      });

  // When user clicks show country button
  function show_countries() {

    // get info
    country = document.getElementById("country_select").value;
    genre = document.getElementById("genre_select").value;

    d3.json("/data/data.json", function(data) {

      // format the data
      data.forEach(function(d) {
          d.date = parseTime(d.date);
      });

      data_filtered = data.filter(function (d) {
        return  d.country == country &&
                d.genre == genre
      });

      data_filtered_sorted = data_filtered.sort(function(a, b) {
          return a.date - b.date;
      });

      data_to_plot.push(data_filtered_sorted);
      plot_lines(data_to_plot);

    })
  };

function plot_lines(data_to_plot){

      var y_max = y_max_trend = y_max_seasonal = y_max_residual = -1000;
      var y_min = y_min_trend = y_min_seasonal = y_min_residual = 1000;

      var year = document.getElementById("year_select").value;

      var extremes = data_to_plot.forEach(function(d) {

        values = d3.extent(d, function(d) {
          return [d.original, d.trend, d.seasonal, d.residual];
        });

        if (y_max < values[1][0]){y_max = values[1][0]};
        if (y_min > values[0][0]){y_min = values[0][0]};

        if (y_max_trend < values[1][1]){y_max_trend = values[1][1]};
        if (y_min_trend > values[0][1]){y_min_trend = values[0][1]};

        if (y_max_seasonal < values[1][2]){y_max_seasonal = values[1][2]};
        if (y_min_seasonal > values[0][2]){y_min_seasonal = values[0][2]};

        if (y_max_residual < values[1][3]){y_max_residual = values[1][3]};
        if (y_min_residual > values[0][3]){y_min_residual = values[0][3]};

      });

      // change axis
      x.domain([parseTime(year + "-01-01"),parseTime(year + "-12-31")]);
      y.domain([y_min,y_max]);
      x_trend.domain([parseTime(year + "-01-01"),parseTime(year + "-12-31")]);
      y_trend.domain([y_min_trend,y_max_trend]);
      x_seasonal.domain([parseTime(year + "-01-01"),parseTime(year + "-12-31")]);
      y_seasonal.domain([y_min_seasonal,y_max_seasonal]);
      x_residual.domain([parseTime(year + "-01-01"),parseTime(year + "-12-31")]);
      y_residual.domain([y_min_residual,y_max_residual]);

 // ORIGINAL
      original_chart.select(".y_axis")
        .call(d3.axisLeft(y));

        // Add the X Axis
      original_chart.select(".x_axis")
        .call(d3.axisBottom(x));

      // Update lines
      original_chart.selectAll(".pc_lines")
        .data(data_to_plot)
        .attr("stroke", function (d, i) { return color[i]; })
        .attr("d", line_original);

      // Enter lines
      original_chart.selectAll(".pc_lines")
        .data(data_to_plot)
        .enter().append("path")
        .attr("class", "pc_lines")
        .style("fill", "none")
        .attr("stroke", function (d, i) { return color[i]; })
        .attr("d", line_original)
        .attr("clip-path", "url(#clip)");;

      // Exit lines
      original_chart.selectAll(".pc_lines")
        .data(data_to_plot)
        .exit().remove();

      // Update legend
      original_chart.selectAll('.legend')
        .data(data_to_plot)
        .attr('fill', function (d, i) { return color[i]; })

      // Enter legend
      var original_legend = original_chart.selectAll('.legend')
        .data(data_to_plot)
        .enter().append('g')
        .attr('class', 'legend');

      original_legend.append('rect')
        .attr('x', width)
        .attr('y', function(d, i) {
          return i * 20;
        })
        .attr('width', 10)
        .attr('height', 10)
        .attr('fill', function (d, i) { return color[i]; })
        .on("click", function(d,i) {
          data_to_plot.splice(i, 1);
          plot_lines(data_to_plot, year);
        });

      original_legend.append('text')
        .attr('x', width + 20)
        .attr('y', function(d, i) {return (i * 20) + 9;})
        .text(function(d) {return (d[0].country + " - " + d[0].genre);})
        .attr('fill', 'black')
        .attr("font-family", "sans-serif")
        .attr("font-size", "12px")
        .attr("fill", "black");

      // Exit legend
      original_chart.selectAll('.legend')
        .data(data_to_plot)
        .exit().remove();

 // TREND
      trend_chart.selectAll(".y_axis")
        .call(d3.axisLeft(y_trend));

        // Add the X Axis
      trend_chart.selectAll(".x_axis")
        .call(d3.axisBottom(x_trend));

      // Update lines
      trend_chart.selectAll(".pc_lines")
        .data(data_to_plot)
        .attr("stroke", function (d, i) { return color[i]; })
        .attr("d", line_trend);

      // Enter lines
      trend_chart.selectAll(".pc_lines")
        .data(data_to_plot)
        .enter().append("path")
        .attr("class", "pc_lines")
        .style("fill", "none")
        .attr("stroke", function (d, i) { return color[i]; })
        .attr("d", line_trend)
        .attr("clip-path", "url(#clip)");;

      // Exit lines
      trend_chart.selectAll(".pc_lines")
        .data(data_to_plot)
        .exit().remove();

      // Update legend
      trend_chart.selectAll('.legend')
        .data(data_to_plot)
        .attr('fill', function (d, i) { return color[i]; })


 // SEASONAL
      seasonal_chart.selectAll(".y_axis")
        .call(d3.axisLeft(y_seasonal));

        // Add the X Axis
      seasonal_chart.selectAll(".x_axis")
        .call(d3.axisBottom(x_seasonal));

      // Update lines
      seasonal_chart.selectAll(".pc_lines")
        .data(data_to_plot)
        .attr("stroke", function (d, i) { return color[i]; })
        .attr("d", line_seasonal);

      // Enter lines
      seasonal_chart.selectAll(".pc_lines")
        .data(data_to_plot)
        .enter().append("path")
        .attr("class", "pc_lines")
        .style("fill", "none")
        .attr("stroke", function (d, i) { return color[i]; })
        .attr("d", line_seasonal)
        .attr("clip-path", "url(#clip)");;

      // Exit lines
      seasonal_chart.selectAll(".pc_lines")
        .data(data_to_plot)
        .exit().remove();

      // Update legend
      seasonal_chart.selectAll('.legend')
        .data(data_to_plot)
        .attr('fill', function (d, i) { return color[i]; })


 // RESIDUAL
      residual_chart.selectAll(".y_axis")
        .call(d3.axisLeft(y_residual));

        // Add the X Axis
      residual_chart.selectAll(".x_axis")
        .call(d3.axisBottom(x_residual));

      // Update lines
      residual_chart.selectAll(".pc_lines")
        .data(data_to_plot)
        .attr("stroke", function (d, i) { return color[i]; })
        .attr("d", line_residual);

      // Enter lines
      residual_chart.selectAll(".pc_lines")
        .data(data_to_plot)
        .enter().append("path")
        .attr("class", "pc_lines")
        .style("fill", "none")
        .attr("stroke", function (d, i) { return color[i]; })
        .attr("d", line_residual)
        .attr("clip-path", "url(#clip)");;

      // Exit lines
      residual_chart.selectAll(".pc_lines")
        .data(data_to_plot)
        .exit().remove();

      // Update legend
      residual_chart.selectAll('.legend')
        .data(data_to_plot)
        .attr('fill', function (d, i) { return color[i]; })

    };

// Enter events
function show_events() {

  // get info
  events = document.getElementById("event_select").value;

  d3.csv("/data/events.csv", function(events_raw) {
    events_raw_filtered = events_raw.filter(function (d) {
    return d.year == "2005";
    });

    // format the data
    events_raw_filtered.forEach(function(d) {
      d.date = parseTime(d.year+"-"+d.month+"-"+d.day);
    });

    function updateEvent(chartname, min, max){
      return chartname.selectAll(".event_lines")
        .data(events_raw_filtered)
        .attr("x1", function (d) { return x(d.date); })
        .attr("y1", y(min))
        .attr("x2", function (d) { return x(d.date); })
        .attr("y2", y(max));
    };

    function enterEvent(chartname, min, max){
      chartname.selectAll(".event_lines")
        .data(events_raw_filtered)
        .enter().append("line")
        .attr("class", "event_lines")
        .style("fill", "none")
        .style("stroke", "black")
        .attr("x1", function (d) { return x(d.date); })
        .attr("y1", y(min))
        .attr("x2", function (d) { return x(d.date); })
        .attr("y2", y(max));
    };

    function exitEvent(chartname){
      chartname.selectAll(".event_lines")
        .data(events_raw_filtered)
        .exit().remove()
    }

    // Update event
    updateEvent(original_chart, y_min, y_max)

    chartname.selectAll(".event_lines")
      .data(events_raw_filtered)
      .attr("x1", function (d) { return x(d.date); })
      .attr("y1", y_residual(y_min_residual))
      .attr("x2", function (d) { return x(d.date); })
      .attr("y2", y_residual(y_max_residual));

    // Enter events
    enterEvent(original_chart, y_min, y_max)

    residual_chart.selectAll(".event_lines")
      .data(events_raw_filtered)
      .enter().append("line")
      .attr("class", "event_lines")
      .style("fill", "none")
      .style("stroke", "black")
      .attr("x1", function (d) { return x(d.date); })
      .attr("y1", y_residual(y_min_residual))
      .attr("x2", function (d) { return x(d.date); })
      .attr("y2", y_residual(y_max_residual));

    // exitEvent
    exitEvent(original_chart)
    exitEvent(residual_chart)

    // Update events
    original_chart.selectAll(".event_text")
      .data(events_raw_filtered)
      .attr("x", function (d) { return x(parseTime(d.year+"-"+d.month+"-"+d.day)); })
      .attr("y", y(y_max));

    // Enter events
    original_chart.selectAll(".event_text")
      .data(events_raw_filtered)
      .enter().append("text")
      .attr("class", "event_text")
      .attr("x", function (d) { return x(parseTime(d.year+"-"+d.month+"-"+d.day)); })
      .attr("y", y(y_max))
      .text( function (d) { return d.description })
      .attr("font-family", "sans-serif")
      .attr("font-size", "6px")
      .attr("fill", "grey");

    // Exit events
    original_chart.selectAll(".event_text")
      .data(events_raw_filtered)
      .exit().remove()
    });

    };
</script>



<!--
<script src="https://npmcdn.com/d3-horizon-chart/build/d3-horizon-chart.min.js"></script>
<script>

function hor_chart(line_list){

  var series =[]

  // generate some random data
  line_list.forEach(function(serie) {



    var temp_list = [];

    // generate some random data
    serie.forEach(function(d, i) {

      for (var j = 0; j<16; j++) {
        temp_list.push(d.relative_play); // only positive values
      };

    });

    var list = {year:serie[0].year, genre:serie[0].genre, country:serie[0].country, data:temp_list};

    series.push(list)

  });

    var horizonChart = d3.horizonChart();
    // 4-band horizon (4 negative & 4 positive bands)
    var colors = ['#313695', '#4575b4', '#74add1', '#abd9e9', '#fee090', '#fdae61', '#f46d43', '#d73027'];
    var n = colors.length / 2;

    var horizons = d3.select('body').selectAll('.horizon')
        .data(series)
        .enter().append('div')
        .attr('class', 'horizon')
        .each(function(d, i) {
            horizonChart.colors(colors)
                .height(40)
                .title(d.year + ' - ' + d.genre + ' - ' + d.country)
                .call(this, d.data);
        });


  }

</script> -->


</body>

</html
