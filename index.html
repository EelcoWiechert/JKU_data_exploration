<html>
<head>
</head>

<body>
<div>
  <select id="country_select">
    <option value="UK">United Kingdom</option>
    <option value="US">United States</option>
  </select>

  <select id="genre_select">
    <option value="rnb">Pop</option>
    <option value="rap">Rock</option>
    <option value="electronic">Pop</option>
    <option value="rock">Rock</option>
    <option value="new age">Pop</option>
    <option value="classical">Rock</option>
    <option value="reggae">Pop</option>
    <option value="blues">Rock</option>
    <option value="country">Pop</option>
    <option value="world">Rock</option>
    <option value="folk">Pop</option>
    <option value="easy listening">Rock</option>
    <option value="jazz">Pop</option>
    <option value="vocal">Rock</option>
    <option value="children's">Pop</option>
    <option value="punk">Rock</option>
    <option value="alternative">Pop</option>
    <option value="heavy metal">Rock</option>
    <option value="spoken word">Pop</option>
    <option value="pop">Rock</option>
  </select>

  <select id="year_select">
    <option value=2005>2005</option>
    <option value=2006>2006</option>
    <option value=2007>2007</option>
    <option value=2008>2008</option>
    <option value=2009>2009</option>
    <option value=2010>2010</option>
    <option value=2011>2011</option>
    <option value=2012>2012</option>
    <option value=2013>2013</option>
    <option value=2014>2014</option>
    <option value=2015>2015</option>
    <option value=2016>2016</option>
  </select>

  <button type="button" onclick="show_countries();">Show</button>

</div>

<div>
  Events
  
  <select id="event_select">
    <option value=2005>2005</option>
    <option value=2006>2006</option>
    <option value=2007>2007</option>
    <option value=2008>2008</option>
    <option value=2009>2009</option>
    <option value=2010>2010</option>
    <option value=2011>2011</option>
    <option value=2012>2012</option>
    <option value=2013>2013</option>
    <option value=2014>2014</option>
    <option value=2015>2015</option>
    <option value=2016>2016</option>
  </select>
  <button type="button" onclick="show_events();">Show</button>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>

<script>

Date.prototype.getWeekNumber = function(){
  var d = new Date(Date.UTC(this.getFullYear(), this.getMonth(), this.getDate()));
  var dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1)/7)
};

function checkWeek(date) {
  var m = moment(date, 'YYYY-MM-DD');
  return m.toDate().getWeekNumber();
}

</script>

<script>

var margin = {top: 50, right: 150, bottom: 50, left: 50}
  , width = window.innerWidth - margin.left - margin.right // Use the window's width
  , height = window.innerHeight - margin.top - margin.bottom; // Use the window's height

  // set the ranges
  var x = d3.scaleLinear().range([0, width]);
  var y = d3.scaleLinear().range([height, 0]);

  x.domain([1,53]);
  y.domain([0,1]);

  var svg = d3.select("body").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

  // Add the X Axis
  svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x));

  // Add the Y Axis
  svg.append("g")
    .attr("class", "y_axis")
    .call(d3.axisLeft(y));

  var data_to_plot = [];
  var y_max = 0;
  var color = ["#377eb8","#4daf4a","#984ea3","#e41a1c","#ff7f00","#a65628"];

  // linedraw function
  var line = d3.line()
      .x(function(d) {return x(d.week);})
      .y(function(d) {return y(d.playcount);
      });

  // When user clicks show country button
  function show_countries() {

    // get info
    country = document.getElementById("country_select").value;
    genre = document.getElementById("genre_select").value;
    year = document.getElementById("year_select").value;

    d3.json("/data/data.json", function(data) {
      data_filtered = data.filter(function (d) {
        return  d.country == country &&
                d.genre == genre &&
                d.year == year;
      });

      data_filtered_sorted = data_filtered.sort(function(a, b) {
          return parseFloat(a.week) - parseFloat(b.week);
      });

      if (y_max < d3.max(data_filtered, function(d) {
	       return Math.max(d.playcount); })){

           y_max = d3.max(data_filtered, function(d) {
     	       return Math.max(d.playcount); })
      };

      data_to_plot.push(data_filtered_sorted);
      plot_lines(data_to_plot);

    })
  };

function plot_lines(data_to_plot){

      // change axis
      x.domain([1,53])
      y.domain([0,y_max]);

      svg.selectAll(".y_axis")
        .call(d3.axisLeft(y));

      // Update lines
      svg.selectAll(".pc_lines")
        .data(data_to_plot)
        .attr("stroke", function (d, i) { return color[i]; })
        .attr("d", line);

      // Enter lines
      svg.selectAll(".pc_lines")
        .data(data_to_plot)
        .enter().append("path")
        .attr("class", "pc_lines")
        .style("fill", "none")
        .attr("stroke", function (d, i) { return color[i]; })
        .attr("d", line);

      // Exit lines
      svg.selectAll(".pc_lines")
        .data(data_to_plot)
        .exit().remove();

      // Update legend
      svg.selectAll('.legend')
        .data(data_to_plot)
        .attr('fill', function (d, i) { return color[i]; })

      // Enter legend
      var legend = svg.selectAll('.legend')
        .data(data_to_plot)
        .enter().append('g')
        .attr('class', 'legend');

      legend.append('rect')
        .attr('x', width)
        .attr('y', function(d, i) {
          return i * 20;
        })
        .attr('width', 10)
        .attr('height', 10)
        .attr('fill', function (d, i) { return color[i]; })
        .on("click", function(d,i) {
          console.log(i);
          data_to_plot.splice(i, 1);
          plot_lines(data_to_plot);
        });

      legend.append('text')
        .attr('x', width + 20)
        .attr('y', function(d, i) {return (i * 20) + 9;})
        .text(function(d) {return (d[0].year + " - " + d[0].country + " - " + d[0].genre);})
        .attr('fill', 'black')
        .attr("font-family", "sans-serif")
        .attr("font-size", "12px")
        .attr("fill", "black");

      // Exit legend
      svg.selectAll('.legend')
        .data(data_to_plot)
        .exit().remove();
    };

    // Enter events
    // When user clicks show country button
    function show_events() {

      // get info
      events = document.getElementById("event_select").value;

    //
    d3.csv("/data/events.csv", function(events_raw) {
      console.log(events_raw[0]);
      events_raw_filtered = events_raw.filter(function (d) {
        return d.year == events;
      });

    // Update events
    svg.selectAll(".event_lines")
      .data(events_raw_filtered)
      .attr("x1", function (d) { return x(checkWeek(d.year+"-"+d.month+"-"+d.day)); })
      .attr("y1", y(0))
      .attr("x2", function (d) { return x(checkWeek(d.year+"-"+d.month+"-"+d.day)); })
      .attr("y2", y(y_max));

    // Enter events
    svg.selectAll(".event_lines")
      .data(events_raw_filtered)
      .enter().append("line")
      .attr("class", "event_lines")
      .style("fill", "none")
      .style("stroke", "black")
      .attr("x1", function (d) { return x(checkWeek(d.year+"-"+d.month+"-"+d.day)); })
      .attr("y1", y(0))
      .attr("x2", function (d) { return x(checkWeek(d.year+"-"+d.month+"-"+d.day)); })
      .attr("y2", y(y_max));

    // Exit events
    svg.selectAll(".event_lines")
      .data(events_raw_filtered)
      .exit().remove()

    // Update events
    svg.selectAll(".event_text")
      .data(events_raw_filtered)
      .attr("x", function (d) { return x(checkWeek(d.year+"-"+d.month+"-"+d.day)); })
      .attr("y", y(y_max));

    // Enter events
    svg.selectAll(".event_text")
      .data(events_raw_filtered)
      .enter().append("text")
      .attr("class", "event_text")
      .attr("x", function (d) { return x(checkWeek(d.year+"-"+d.month+"-"+d.day)); })
      .attr("y", y(y_max))
      .text( function (d) { return d.description })
      .attr("font-family", "sans-serif")
      .attr("font-size", "6px")
      .attr("fill", "grey");

    // Exit events
    svg.selectAll(".event_text")
      .data(events_raw_filtered)
      .exit().remove()
    });

    };
</script>

</body>

</html
