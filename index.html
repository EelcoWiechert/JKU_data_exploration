<html>
<head>
</head>

<body>

<select id="country_select">
  <option value="UK">United Kingdom</option>
  <option value="US">United States</option>
</select>
<button type="button" onclick="show_countries();">Show</button>

<select id="event_select">
  <option value=2005>2005</option>
  <option value=2006>2006</option>
</select>
<button type="button" onclick="show_events();">Show</button>


<script src="https://d3js.org/d3.v4.min.js"></script>

<script>

// Returns the ISO week of the date.
Date.prototype.getWeek = function() {
  var date = new Date(this.getTime());
   date.setHours(0, 0, 0, 0);
  // Thursday in current week decides the year.
  date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
  // January 4 is always in week 1.
  var week1 = new Date(date.getFullYear(), 0, 4);
  // Adjust to Thursday in week 1 and count number of weeks from date to week1.
  return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000
                        - 3 + (week1.getDay() + 6) % 7) / 7);
}

</script>

<script>

var margin = {top: 50, right: 150, bottom: 50, left: 50}
  , width = window.innerWidth - margin.left - margin.right // Use the window's width
  , height = window.innerHeight - margin.top - margin.bottom; // Use the window's height

  // set the ranges
  var x = d3.scaleLinear().range([0, width]);
  var y = d3.scaleLinear().range([height, 0]);

  x.domain([1,53]);
  y.domain([0,1]);

  var svg = d3.select("body").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

  // Add the X Axis
  svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x));

  // Add the Y Axis
  svg.append("g")
    .attr("class", "y_axis")
    .call(d3.axisLeft(y));

  var data_to_plot = [];
  var y_max = 0;
  var color = ["#377eb8","#4daf4a","#984ea3","#e41a1c","#ff7f00","#a65628"];

  // linedraw function
  var line = d3.line()
      .x(function(d) {return x(d.week);})
      .y(function(d) {return y(d.playcount);
      });

  // When user clicks show country button
  function show_countries() {

    // get info
    country = document.getElementById("country_select").value;

    d3.json("/data/data.json", function(data) {
      data_filtered = data.filter(function (d) {
        return  d.country == country &&
                d.genre == 'pop' &&
                d.year == '2005';
      });

      data_filtered_sorted = data_filtered.sort(function(a, b) {
          return parseFloat(a.week) - parseFloat(b.week);
      });

      if (y_max < d3.max(data_filtered, function(d) {
	       return Math.max(d.playcount); })){

           y_max = d3.max(data_filtered, function(d) {
     	       return Math.max(d.playcount); })

      };

      data_to_plot.push(data_filtered_sorted);

      plot_lines(data_to_plot);

    })
  };

function plot_lines(data_to_plot){

      // change axis
      x.domain([1,53])
      y.domain([0,y_max]);

      svg.selectAll(".y_axis")
        .call(d3.axisLeft(y));

      // Update lines
      svg.selectAll(".pc_lines")
        .data(data_to_plot)
        .attr("stroke", function (d, i) { return color[i]; })
        .attr("d", line);

      // Enter lines
      svg.selectAll(".pc_lines")
        .data(data_to_plot)
        .enter().append("path")
        .attr("class", "pc_lines")
        .style("fill", "none")
        .attr("stroke", function (d, i) { return color[i]; })
        .attr("d", line);

      // Exit lines
      svg.selectAll(".pc_lines")
        .data(data_to_plot)
        .exit().remove();

      // Update legend
      svg.selectAll('.legend')
        .data(data_to_plot)
        .attr('fill', function (d, i) { return color[i]; })

      // Enter legend
      var legend = svg.selectAll('.legend')
        .data(data_to_plot)
        .enter().append('g')
        .attr('class', 'legend');

      legend.append('rect')
        .attr('x', width)
        .attr('y', function(d, i) {
          return i * 20;
        })
        .attr('width', 10)
        .attr('height', 10)
        .attr('fill', function (d, i) { return color[i]; })
        .on("click", function(d,i) {
          console.log(i);
          data_to_plot.splice(i, 1);
          plot_lines(data_to_plot);
        });

      legend.append('text')
        .attr('x', width + 20)
        .attr('y', function(d, i) {return (i * 20) + 9;})
        .text(function(d) {return (d[0].year + " - " + d[0].country + " - " + d[0].genre);})
        .attr('fill', 'black');

      // Exit legend
      svg.selectAll('.legend')
        .data(data_to_plot)
        .exit().remove();
    };

    // Enter events
    // When user clicks show country button
    function show_events() {

      // get info
      events = document.getElementById("event_select").value;

      console.log(events);
      console.log((2017/02/05).getWeekYear());

      d3.csv("data/events.csv". function(events))  {
        events_filtered = events.filter(function(d) {
          return d.year == 2005;
        });

        // Enter lines
        svg.selectAll(".event_lines")
          .data(events_filtered)
          .enter().append("line")
          .attr("class", "event_lines")
          .style("fill", "none")
          .style("stroke", "black")  // colour the line
          .attr("x1", 100)     // x position of the first end of the line
          .attr("y1", 0)      // y position of the first end of the line
          .attr("x2", 300)     // x position of the second end of the line
          .attr("y2", y_max);    // y position of the second end of the line

      };

    };

</script>

</body>


</html
